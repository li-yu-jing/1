<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=375, initial-scale=1.0" />
  <title>街友安置體驗</title>
  <style>
    body {
      margin: 0;
      background-color: #222;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      font-family: 'Noto Sans TC', sans-serif;
    }
    .game-container {
      width: 375px;
      height: 667px;
      position: relative;
      background-color: black;
      box-shadow: 0 0 10px rgba(0,0,0,0.5);
      overflow: hidden;
    }
    
    #background-image-element {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
        opacity: 1;
        z-index: 1;
    }
    .content,
    .speech-bubble,
    .start-screen,
    #introVideo,
    #interactive-image-container,
    #imageStepBtn,
    .end-screen {
      position: absolute;
      z-index: 2;
    }
    
    #clickOverlay {
      position: absolute;
      z-index: 5;
    }
    
    #introVideo {
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: none;
      z-index: 3;
    }
    #interactive-image-container {
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: none;
        z-index: 2;
        pointer-events: none;
    }
    .overlay-image {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: contain;
        display: block;
    }
    .content {
      bottom: 18px;
      width: 100%;
      text-align: center;
      display: none;
    }
    .btn {
      margin: 10px;
      padding: 10px 20px;
      border: 2px solid black;
      background-color: white;
      color: black;
      font-size: 16px;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .btn:hover {
      background-color: #f0f0f0;
      transform: scale(1.05);
    }
    .speech-bubble {
      bottom: 150px;
      left: 20px;
      right: 20px;
      background: rgba(255,255,255,0.9);
      padding: 10px 15px;
      border-radius: 10px;
      font-weight: bold;
      font-size: 16px;
      display: none;
    }
    .start-screen {
      background-image: url('開場白02.png');
      background-size: cover;
      background-position: center;
      top: 0; left: 0; width: 100%; height: 100%;
      cursor: pointer;
    }
    .end-screen {
      width: 100%;
      height: 100%;
      background-size: cover;
      background-position: center;
      display: none;
      justify-content: center;
      align-items: center;
      flex-direction: column;
    }
    .end-message {
      background-color: rgba(0,0,0,0.6);
      color: white;
      padding: 20px;
      border-radius: 12px;
      font-size: 22px;
      text-align: center;
      margin-bottom: 20px;
    }
    #clickOverlay {
      display: none;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      cursor: pointer;
      background-color: transparent;
    }
    #imageStep {
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        height: auto;
        display: flex;
        justify-content: center;
        align-items: flex-end;
        display: none;
        z-index: 4;
    }
    #imageStepBtn {
      background-color: transparent !important;
      color: white;
      border: none;
      padding: 0;
      display: none;
      width: 250px;
      height: auto;
      object-fit: contain;
      cursor: pointer;
      margin-bottom: 50px;
    }
    .line-button {
      width: 180px;
      height: auto;
      transition: transform 0.3s ease;
      cursor: pointer;
    }
    .line-button:hover {
      transform: scale(1.05);
    }
    #loadingScreen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: black;
      color: white;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 24px;
      z-index: 9999;
      opacity: 1;
      transition: opacity 1s ease-out;
    }
  </style>
</head>
<body>
  <div id="loadingScreen">載入中... 0%</div>
  <div class="game-container" id="mainGameContainer">
    <img id="background-image-element" src="" alt="背景圖片">
    <div id="interactive-image-container">
        </div>
    <div class="speech-bubble" id="speech"></div>
    <div class="content" id="choices"></div>
    <div class="start-screen" id="startScreen">
      <div style="position: absolute; bottom: 20px; width: 100%; text-align: center; color: white; font-size: 16px;">
        點擊畫面繼續
      </div>
    </div>
    <video id="introVideo" playsinline autoplay muted preload="auto">
      <source src="" type="video/mp4">
      您的瀏覽器不支援 HTML5 視訊。
    </video>
    <div id="imageStep">
      <img id="imageStepBtn" src="點擊畫面繼續.png" alt="下一步" />
    </div>
    <div class="end-screen" id="endScreen"></div>
    <div id="clickOverlay"></div>
  </div>
  <audio id="backgroundMusic" src="BGM.mp3" loop preload="auto"></audio>
  <audio id="buttonSound" src="按鈕音效.mp3" preload="auto"></audio>
  
  <script>
    const allImages = [
      '開場白02.png', 'Line回覆更.png', '生活公約03.png', '我已閱讀按鈕.png',
      'day3.png', '團康甩手功.png', 'day04.png', '強制參加團康活動.png',
      '交友圈.png', '苦惱的我.png', '室友很煩.png', '想喝酒.png', '社工抓包.png', '職涯課.png',
      '找工作.png', '社工推薦打掃工作.png', '給社工管錢.png', '沒錢了.png', '戒菸酒.png', '買飲料.png',
      '翻包包.png', '租屋.png', '翻包2.png', '超時.png', 'Line按鈕.png',
      '計點規則1.png','計點規則2.png', '計點規則3.png','計點規則4.png',
      '計點規則5.png','計點規則6.png',
      '點擊畫面繼續.png',
      'Line對話1.png', 'Line對話2.png', 'Line對話3.png', 'Line對話穿插03.png',
      'Line對話4.png', 'Line對話5.png', 'Line對話6.png', 'Line對話7.png'
    ];
    const allVideos = [
    'Line對話影片03.mp4'
    ];
    const allAudio = [
      'BGM.mp3',
      '按鈕音效.mp3'
    ];
    
    const interactiveSequence = [
        { type: 'lineChatSeriesInit', bg: 'Line對話1.png', button: '點擊畫面繼續.png' },
        { type: 'lineChatSeriesOverlay', overlay: 'Line對話2.png', button: '點擊畫面繼續.png' },
        { type: 'lineChatSeriesOverlay', overlay: 'Line對話3.png', button: '點擊畫面繼續.png' },
        { type: 'lineChatSeriesOverlay', overlay: 'Line對話穿插03.png', button: '點擊畫面繼續.png', hideOnNext: true },
        { type: 'lineChatSeriesOverlay', overlay: 'Line對話4.png', button: '點擊畫面繼續.png' },
        { type: 'lineChatSeriesOverlay', overlay: 'Line對話5.png', button: '點擊畫面繼續.png' },
        { type: 'lineChatSeriesOverlay', overlay: 'Line對話6.png', button: 'Line按鈕.png' },
        { type: 'lineChatSeriesOverlay', overlay: 'Line對話7.png', button: '點擊畫面繼續.png', clearOnNext: true },
        { type: 'video', src: 'Line對話影片03.mp4' },
        { type: 'static', bg: '生活公約03.png', button: '我已閱讀按鈕.png' },
        { type: 'static', bg: '計點規則1.png', button: '點擊畫面繼續.png' },
        { type: 'static', bg: '計點規則2.png', button: '點擊畫面繼續.png' },
        { type: 'static', bg: '計點規則4.png', button: '點擊畫面繼續.png' },
        { type: 'static', bg: '計點規則5.png', button: '點擊畫面繼續.png' },
        { type: 'static', bg: '計點規則6.png', button: '點擊畫面繼續.png' }
    ];
    let currentInteractiveStep = 0;
    
    // 獲取 DOM 元素
    const startScreen = document.getElementById('startScreen');
    const introVideo = document.getElementById('introVideo');
    const imageStep = document.getElementById('imageStep');
    const imageStepBtn = document.getElementById('imageStepBtn');
    const mainGameContainer = document.getElementById('mainGameContainer');
    const speech = document.getElementById('speech');
    const choices = document.getElementById('choices');
    const loadingScreen = document.getElementById('loadingScreen');
    const clickOverlay = document.getElementById('clickOverlay');
    const backgroundImageElement = document.getElementById('background-image-element');
    const interactiveImageContainer = document.getElementById('interactive-image-container');
    const backgroundMusic = document.getElementById('backgroundMusic');
    const buttonSound = document.getElementById('buttonSound');
    
    function playButtonSound() {
        if (buttonSound) {
            buttonSound.currentTime = 0;
            buttonSound.play().catch(e => console.warn("按鈕音效播放失敗:", e));
        }
    }
    
    function setBackground(imageSrc, callback = () => {}) {
        introVideo.style.display = 'none';
        backgroundImageElement.src = imageSrc;
        backgroundImageElement.style.display = 'block';
        
        // 修复：确保回调在图片加载完成后执行
        if (backgroundImageElement.complete && backgroundImageElement.naturalWidth > 0) {
            setTimeout(callback, 50); // 小延迟确保DOM更新
        } else {
            backgroundImageElement.onload = () => {
                setTimeout(callback, 50);
            };
            backgroundImageElement.onerror = () => {
                console.warn(`背景图片加载失败: ${imageSrc}`);
                setTimeout(callback, 50);
            };
        }
    }
    
    function preloadAllAssets(images, videos, audio, callback) {
        let loadedCount = 0;
        const totalAssets = images.length + videos.length + audio.length;
        if (totalAssets === 0) {
            callback();
            return;
        }
        const updateLoadingProgress = () => {
            loadedCount++;
            const progress = Math.floor((loadedCount / totalAssets) * 100);
            loadingScreen.innerText = `載入中... ${progress}%`;
            if (loadedCount === totalAssets) {
                callback();
            }
        };
        images.forEach(imgSrc => {
            const img = new Image();
            img.src = imgSrc;
            img.onload = updateLoadingProgress;
            img.onerror = updateLoadingProgress;
        });
        videos.forEach(vidSrc => {
            const vid = document.createElement('video');
            vid.src = vidSrc;
            vid.oncanplaythrough = updateLoadingProgress;
            vid.onerror = updateLoadingProgress;
            vid.load();
        });
        audio.forEach(audioSrc => {
            const aud = new Audio();
            aud.src = audioSrc;
            aud.oncanplaythrough = updateLoadingProgress;
            aud.onerror = updateLoadingProgress;
            aud.load();
        });
    }
    
    window.addEventListener('load', () => {
        preloadAllAssets(allImages, allVideos, allAudio, () => {
            loadingScreen.style.opacity = 0;
            loadingScreen.addEventListener('transitionend', () => {
                loadingScreen.style.display = 'none';
                startScreen.style.display = 'block';
            }, { once: true });
        });
    });
    
    startScreen.addEventListener("click", () => {
        startScreen.style.display = "none";
        backgroundMusic.play().then(() => {
            console.log("背景音樂成功播放！");
            showNextInteractiveStep();
        }).catch(error => {
            console.warn("背景音樂自動播放失敗，可能需要用戶互動，但遊戲仍會繼續:", error);
            showNextInteractiveStep();
        });
    });
    
    function showNextInteractiveStep() {
        speech.style.display = 'none';
        choices.style.display = 'none';
        imageStepBtn.style.display = 'none';
        imageStep.style.display = 'none';
        introVideo.style.display = 'none';
        
        if (currentInteractiveStep < interactiveSequence.length) {
            const step = interactiveSequence[currentInteractiveStep];
            if (currentInteractiveStep > 0) {
                const prevStep = interactiveSequence[currentInteractiveStep - 1];
                if ((prevStep.type === 'lineChatSeriesOverlay' && prevStep.hideOnNext)) {
                    if (interactiveImageContainer.lastElementChild) {
                        interactiveImageContainer.lastElementChild.style.display = 'none';
                    }
                }
                if (prevStep.type === 'lineChatSeriesOverlay' && prevStep.clearOnNext) {
                    interactiveImageContainer.innerHTML = '';
                    interactiveImageContainer.style.display = 'none';
                }
            }
            if (step.type === 'lineChatSeriesInit') {
                interactiveImageContainer.innerHTML = '';
                setBackground(step.bg, () => {
                    interactiveImageContainer.style.display = 'block';
                    imageStep.style.display = 'flex';
                    imageStepBtn.src = step.button || "點擊畫面繼續.png";
                    imageStepBtn.classList.remove('line-button');
                    imageStepBtn.style.display = 'block';
                });
            } else if (step.type === 'lineChatSeriesOverlay') {
                const overlayImg = document.createElement('img');
                overlayImg.src = step.overlay;
                overlayImg.classList.add('overlay-image');
                interactiveImageContainer.appendChild(overlayImg);
                backgroundImageElement.style.display = 'block';
                interactiveImageContainer.style.display = 'block';
                imageStep.style.display = 'flex';
                imageStepBtn.src = step.button || "點擊畫面繼續.png";
                imageStepBtn.classList.remove('line-button');
                if (step.button === 'Line按鈕.png') {
                    imageStepBtn.classList.add('line-button');
                }
                imageStepBtn.style.display = 'block';
            } else if (step.type === 'static') {
                interactiveImageContainer.innerHTML = '';
                interactiveImageContainer.style.display = 'none';
                setBackground(step.bg, () => {
                    imageStep.style.display = 'flex';
                    imageStepBtn.src = step.button || "點擊畫面繼續.png";
                    imageStepBtn.classList.remove('line-button');
                    imageStepBtn.style.display = 'block';
                });
            } else if (step.type === 'video') {
                backgroundImageElement.style.display = 'none';
                interactiveImageContainer.innerHTML = '';
                interactiveImageContainer.style.display = 'none';
                introVideo.src = step.src;
                introVideo.style.display = 'block';
                introVideo.play();
                introVideo.onended = () => {
                    currentInteractiveStep++;
                    showNextInteractiveStep();
                };
                return;
            }
        } else {
            console.log("Interactive sequence finished, transitioning to startScene.");
            backgroundImageElement.style.display = 'none';
            interactiveImageContainer.style.display = 'none';
            interactiveImageContainer.innerHTML = '';
            startScene();
            return;
        }
    }
    
    imageStepBtn.addEventListener("click", () => {
        playButtonSound();
        currentInteractiveStep++;
        showNextInteractiveStep();
    });
    
    function startScene() {
        console.log("Starting main game scene...");
        goTo("accept");
    }
    
    // 场景数据
    const scenes = {
      accept: {
        bg: 'day3.png',
        speech: '第一次踏進安置機構，印入我眼簾的這棟雙層樓的老屋，鐵皮屋頂鏽蝕、牆面斑駁，但中庭寬闊，四周圍繞著寢室。',
        autoNext: 'd1',
        choices: [] 
      },
      d1: {
        bg: 'day3.png',
        speech: '房內擺滿雙層床，金屬床架沿牆排開，空間顯得擁擠而充滿生活感。這裡或許稱不上舒適，但至少給了許多和我一樣的街友一個棲身之所。',
        autoNext: 'd2',
        choices: []
      },
      d2: {
        bg: 'day3.png',
        speech: '對我來說，一切還很陌生，還不太知道該怎麼開始新的生活。',
        choices: [
          { text: '決定先觀察一陣子，獨自在房間休息', next: 'bbb' },
          { text: '趕快嘗試看看能不能適應新生活', next: 'aaa' }
        ]
      },
      aaa: {
        bg: '團康甩手功.png',
        speech: '吃完早餐，社工公布今天的團康活動，全體住民都要參加手工藝課。',
        autoNext: 'd3',
        choices: []
      },
      d3: {
        bg: '團康甩手功.png',
        speech: '聽到社工的公告，有些老住民已經習慣的開始動作，我卻還坐在角落。',
        autoNext: 'd4',
        choices: []
      },
      d4: {
        bg: '團康甩手功.png',
        speech: '不清楚這些安排對我有沒有幫助，而且我還不太認識這邊的其他住民和生活輔導員⋯⋯',
        choices: [
          { text: '不願參加，找理由推託', next: 'ddd' },
          { text: '勉強參加，但覺得無聊', next: 'ccc' }
        ]
      },
      bbb: {
        bg: 'day04.png',
        speech: '早上的團體活動時間，住在街頭多年的我早就過慣了沒日沒夜的生活，只想躺著休息。',
        autoNext: 'd5',
        choices: []
      },
      d5: {
        bg: 'day04.png',
        speech: '但才剛躺下，生活輔導員就在門口催促我：「起來囉，要去打掃跟做早操了，每天早上都要，大家都得去。」',
        autoNext: 'd6',
        choices: []
      },
      d6: {
        bg: 'day04.png',
        speech: '我知道這是規定，但真的不太習慣這種被安排好的團體生活⋯⋯',
        choices: [
          { text: '草草應付參加活動', next: 'ccc' },
          { text: '拒絕並表現不滿', next: 'ddd' }
        ]
      },
      // 添加缺失的场景以避免错误
      ccc: {
        bg: 'day04.png',
        speech: '你選擇了勉強參加活動...',
        choices: [
          { text: '繼續遊戲', next: 'accept' }
        ]
      },
      ddd: {
        bg: 'day04.png',
        speech: '你選擇了拒絕參加...',
        choices: [
          { text: '重新開始', next: 'accept' }
        ]
      }
    };

    let currentScene = 'accept';

    function goTo(key) {
      if (!scenes[key]) {
        console.error(`場景 ${key} 不存在！`);
        return;
      }
      
      console.log(`Going to scene: ${key}`);
      
      currentScene = key;
      const scene = scenes[key];
      
      // 清理所有现有的事件监听器和显示状态
      speech.style.display = 'none';
      choices.style.display = 'none';
      clickOverlay.style.display = 'none';
      clickOverlay.onclick = null;
      
      // 移除所有可能的旧事件监听器
      const newClickOverlay = clickOverlay.cloneNode(true);
      clickOverlay.parentNode.replaceChild(newClickOverlay, clickOverlay);
      
      // 重新获取新的clickOverlay引用
      const currentClickOverlay = document.getElementById('clickOverlay');
      
      setBackground(scene.bg, () => {
        speech.innerText = scene.speech;
        speech.style.display = 'block';
        
        if (scene.choices.length > 0) {
          // 显示选项按钮
          choices.innerHTML = scene.choices.map(choice =>
            `<button class="btn" onclick="playButtonSound(); goTo('${choice.next}')">${choice.text}</button>`
          ).join('');
          choices.style.display = 'block';
          currentClickOverlay.style.display = 'none';
        } else if (scene.autoNext) {
          // 修复autoNext的处理
          choices.innerHTML = '<div style="color: white; font-size: 14px; margin-top: 10px;">（點擊畫面繼續）</div>';
          choices.style.display = 'block';
          
          currentClickOverlay.style.display = 'block';
          currentClickOverlay.style.width = '100%';
          currentClickOverlay.style.height = '100%';
          currentClickOverlay.style.top = '0';
          currentClickOverlay.style.left = '0';
          currentClickOverlay.style.position = 'absolute';
          currentClickOverlay.style.zIndex = '10';
          
          // 添加点击事件处理
          currentClickOverlay.addEventListener('click', function handleAutoNext(event) {
            console.log('clickOverlay clicked for autoNext:', scene.autoNext);
            event.preventDefault();
            event.stopPropagation();
            
            playButtonSound();
            goTo(scene.autoNext);
          }, { once: true });
          
        } else {
          choices.innerHTML = '';
          currentClickOverlay.style.display = 'none';
        }
      });
    }
  </script>
</body>
</html>
